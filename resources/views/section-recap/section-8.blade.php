<h3 class="mt-3 text-center">Section 8 (Identifikasi pengelolaan risiko teknologi informasi Bagian Pertama: Pengumpulan
    Data Risiko TI)</h3>

<!-- Deskripsi -->
<p class="mt-3">
    Bagian pertama dari Pengelolaan Risiko Teknologi Informasi (TI) ini bertujuan untuk mengevaluasi bagaimana
    organisasi mengumpulkan data terkait risiko TI. Kuisioner ini berfokus pada identifikasi sumber data, keakuratan,
    dan kelengkapan data yang digunakan dalam manajemen risiko.
    <br>
    Untuk setiap pernyataan yang diberikan, harap pilih <strong>Ya</strong> atau <strong>Tidak</strong> sesuai dengan
    kondisi yang berlaku di organisasi
    Anda.
</p>

<div class="text-end mb-3">
    <small id="lastUpdated-section-8" class="text-muted"></small>
</div>

<!-- Tabel -->
<div class="table-responsive mt-4">
    <table class="table table-bordered">
        <thead class="thead-light">
            <tr>
                <th>Aktifitas</th>
                <th>Aktifitas Dilakukan (Ya/Tidak)</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Menyusun dan memelihara metode untuk mengumpulkan,
                    mengklasifikasikan, dan menganalisis data yang terkait dengan
                    risiko Teknologi Informasi (TI).</td>
                <td>
                    <div style="width: 120px; height: 120px; margin: auto;">
                        <canvas id="section_8_1"></canvas>
                    </div>
                    <div class="mt-2 text-center">
                        <span class="badge" style="background-color: #36A2EB;">Ya</span>
                        <span class="badge" style="background-color: #FF6384;">Tidak</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>Mencatat data risiko TI yang relevan dan signifikan berdasarkan
                    lingkungan operasional internal dan eksternal organisasi.</td>
                <td>
                    <div style="width: 120px; height: 120px; margin: auto;">
                        <canvas id="section_8_2"></canvas>
                    </div>
                    <div class="mt-2 text-center">
                        <span class="badge" style="background-color: #36A2EB;">Ya</span>
                        <span class="badge" style="background-color: #FF6384;">Tidak</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>Mengadopsi atau mendefinisikan taksonomi risiko untuk
                    memastikan konsistensi dalam mendefinisikan skenario risiko
                    serta kategori dampak dan kemungkinan.</td>
                <td>
                    <div style="width: 120px; height: 120px; margin: auto;">
                        <canvas id="section_8_3"></canvas>
                    </div>
                    <div class="mt-2 text-center">
                        <span class="badge" style="background-color: #36A2EB;">Ya</span>
                        <span class="badge" style="background-color: #FF6384;">Tidak</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>Mencatat data tentang kejadian risiko yang telah atau mungkin
                    menyebabkan dampak bisnis, sesuai dengan kategori dampak
                    yang telah didefinisikan dalam taksonomi risiko. Mengumpulkan
                    data relevan dari masalah, insiden, dan investigasi terkait.</td>
                <td>
                    <div style="width: 120px; height: 120px; margin: auto;">
                        <canvas id="section_8_4"></canvas>
                    </div>
                    <div class="mt-2 text-center">
                        <span class="badge" style="background-color: #36A2EB;">Ya</span>
                        <span class="badge" style="background-color: #FF6384;">Tidak</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>Menganalisis data historis risiko TI dan pengalaman kerugian dari
                    sumber eksternal seperti tren industri, log peristiwa, database, dan
                    kesepakatan bersama.</td>
                <td>
                    <div style="width: 120px; height: 120px; margin: auto;">
                        <canvas id="section_8_5"></canvas>
                    </div>
                    <div class="mt-2 text-center">
                        <span class="badge" style="background-color: #36A2EB;">Ya</span>
                        <span class="badge" style="background-color: #FF6384;">Tidak</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>Mengorganisasi data yang dikumpulkan untuk kejadian serupa
                    dan menyoroti faktor penyebab utama. Menentukan faktor umum
                    yang memengaruhi berbagai kejadian.</td>
                <td>
                    <div style="width: 120px; height: 120px; margin: auto;">
                        <canvas id="section_8_6"></canvas>
                    </div>
                    <div class="mt-2 text-center">
                        <span class="badge" style="background-color: #36A2EB;">Ya</span>
                        <span class="badge" style="background-color: #FF6384;">Tidak</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>Menentukan kondisi tertentu yang ada atau tidak ada saat kejadian
                    risiko terjadi dan bagaimana kondisi tersebut memengaruhi
                    frekuensi kejadian serta besarnya kerugian.</td>
                <td>
                    <div style="width: 120px; height: 120px; margin: auto;">
                        <canvas id="section_8_7"></canvas>
                    </div>
                    <div class="mt-2 text-center">
                        <span class="badge" style="background-color: #36A2EB;">Ya</span>
                        <span class="badge" style="background-color: #FF6384;">Tidak</span>
                    </div>
                </td>
            </tr>
            <tr>
                <td>Melakukan analisis berkala terhadap kejadian dan faktor risiko
                    untuk mengidentifikasi masalah risiko baru dan memahami faktor
                    risiko internal serta eksternal terkait.</td>
                <td>
                    <div style="width: 120px; height: 120px; margin: auto;">
                        <canvas id="section_8_8"></canvas>
                    </div>
                    <div class="mt-2 text-center">
                        <span class="badge" style="background-color: #36A2EB;">Ya</span>
                        <span class="badge" style="background-color: #FF6384;">Tidak</span>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <h4 class="mt-4 text-center">Kritik dan Saran Section 8</h4>
    <div id="kritikSaranCarousel-section-8" class="carousel slide" data-ride="carousel">
        <div class="carousel-inner" id="kritikSaranContent-section-8">
            <div class="carousel-item active">
            </div>
        </div>
        <a class="carousel-control-prev" href="#kritikSaranCarousel-section-8" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
        </a>
        <a class="carousel-control-next" href="#kritikSaranCarousel-section-8" role="button" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
        </a>
    </div>
</div>

@push('scripts')
    <script>
        // Chart instances
        let section_8_1, section_8_2, section_8_3, section_8_4, section_8_5, section_8_6, section_8_7, section_8_8;

        // Fungsi untuk inisialisasi chart
        function createChart(canvasId, data) {
            const ctx = document.getElementById(canvasId).getContext("2d");
            return new Chart(ctx, {
                type: "pie",
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false,
                        },
                    },
                },
            });
        }

        // Fetch and update data
        async function fetchData_section_8(formId) {
            try {
                const response = await fetch(`/data-section-8/${formId}`);
                const data = await response.json();

                if (data) {
                    section_8_1.data.datasets[0].data = [
                        data.pertanyaan_1_jawaban_ya,
                        data.pertanyaan_1_jawaban_tidak,
                    ];
                    section_8_1.update();

                    section_8_2.data.datasets[0].data = [
                        data.pertanyaan_2_jawaban_ya,
                        data.pertanyaan_2_jawaban_tidak,
                    ];
                    section_8_2.update();

                    section_8_3.data.datasets[0].data = [
                        data.pertanyaan_3_jawaban_ya,
                        data.pertanyaan_3_jawaban_tidak,
                    ];
                    section_8_3.update();

                    section_8_4.data.datasets[0].data = [
                        data.pertanyaan_4_jawaban_ya,
                        data.pertanyaan_4_jawaban_tidak,
                    ];
                    section_8_4.update();

                    section_8_5.data.datasets[0].data = [
                        data.pertanyaan_5_jawaban_ya,
                        data.pertanyaan_5_jawaban_tidak,
                    ];
                    section_8_5.update();

                    section_8_6.data.datasets[0].data = [
                        data.pertanyaan_6_jawaban_ya,
                        data.pertanyaan_6_jawaban_tidak,
                    ];
                    section_8_6.update();

                    section_8_7.data.datasets[0].data = [
                        data.pertanyaan_7_jawaban_ya,
                        data.pertanyaan_7_jawaban_tidak,
                    ];
                    section_8_7.update();

                    section_8_8.data.datasets[0].data = [
                        data.pertanyaan_8_jawaban_ya,
                        data.pertanyaan_8_jawaban_tidak,
                    ];
                    section_8_8.update();


                    // Update last updated timestamp if needed
                    if (data) {
                        const totalResponses = data.total_responses ?? 0;
                        const totalAuditee = data.total_auditee ?? 0;
                        const lastUpdated = data.last_updated_at ?
                            `Terakhir diperbarui: ${new Date(data.last_updated_at).toLocaleString('id-ID')}` :
                            'Belum ada data';

                        document.getElementById('lastUpdated-section-8').textContent =
                            `Total Responden: ${totalResponses} Orang dari ${totalAuditee} Auditee, ${lastUpdated}`;
                    } else {
                        document.getElementById('lastUpdated-section-8').textContent =
                            'Belum ada data tersedia';
                    }
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Initialize charts
        document.addEventListener('DOMContentLoaded', function() {
            // Create charts
            section_8_1 = createChart("section_8_1", {
                ...dataTemplate2
            });

            section_8_2 = createChart("section_8_2", {
                ...dataTemplate2
            });

            section_8_3 = createChart("section_8_3", {
                ...dataTemplate2
            });

            section_8_4 = createChart("section_8_4", {
                ...dataTemplate2
            });

            section_8_5 = createChart("section_8_5", {
                ...dataTemplate2
            });

            section_8_6 = createChart("section_8_6", {
                ...dataTemplate2
            });

            section_8_7 = createChart("section_8_7", {
                ...dataTemplate2
            });

            section_8_8 = createChart("section_8_8", {
                ...dataTemplate2
            });

            // Fetch initial data (replace 1 with your actual form_id)
            fetchData_section_8('{{ $form->id }}');
        });

        $(document).ready(function() {
            let formId = '{{ $form->id }}'; // Ganti dengan ID form yang sesuai
            $.ajax({
                url: `/kritik-saran-section-8/${formId}`,
                method: "GET",
                success: function(data) {
                    let container = $("#kritikSaranContent-section-8");
                    container.empty(); // Kosongkan kontainer sebelum menambahkan data baru

                    if (data.kritik_saran === "Tidak ada kritik dan saran") {
                        container.append(`<div class="carousel-item active">
                        <div class="card shadow-sm p-3">
                            <p class="text-dark text-center">Tidak ada kritik dan saran tersedia</p>
                        </div>
                    </div>`);
                        return;
                    }

                    $.each(data, function(index, item) {
                        let isActive = index === 0 ? "active" : "";
                        container.append(`<div class="carousel-item ${isActive}">
                        <div class="card shadow-sm p-4">
                            <p class="text-primary font-weight-bold text-center"
                            style="font-size: 1.2rem;">"${item.kritik_saran}"</p>
                        </div>
                    </div>`);
                    });

                    // Aktifkan carousel setelah data dimuat
                    $('#kritikSaranCarousel-section-8').carousel();
                },
                error: function() {
                    console.error("Error mengambil data");
                }
            });
        });
    </script>
@endpush
